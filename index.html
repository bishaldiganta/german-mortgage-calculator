<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>German Home Financing Calculator</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f7f6; color: #333; padding: 20px; }
    .container { max-width: 900px; margin: auto; background: #fff; padding: 20px 30px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    h1, h2 { color: #0056b3; margin-bottom: 5px;}
    .loan-section { border: 1px solid #e1e4e8; padding: 15px; margin-bottom: 20px; border-radius: 8px; background-color: #fafbfc; }
    .row { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 15px; align-items: flex-end; }
    .form-group { display: flex; flex-direction: column; flex: 1; min-width: 150px; }
    label { font-weight: bold; margin-bottom: 5px; font-size: 0.9em; }
    input, select { padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 1em; }
    .result-group { background: #eef1f5; padding: 10px; border-radius: 5px; text-align: center; font-weight: bold; color: #0056b3; flex: 1; display: flex; align-items: center; justify-content: center;}
    .summary-section { background: #0056b3; color: white; padding: 20px; border-radius: 8px; margin-top: 20px; }
    .summary-row { display: flex; justify-content: space-between; font-size: 1.2em; margin-bottom: 10px; }
    .summary-row span { font-weight: bold; }
    .button-group { display: flex; gap: 10px; margin-top: 20px; }
    button { flex: 1; background-color: #28a745; color: white; border: none; padding: 12px 20px; font-size: 1.1em; border-radius: 5px; cursor: pointer; transition: background 0.3s;}
    button:hover { background-color: #218838; }
    .btn-secondary { background-color: #6c757d; }
    .btn-secondary:hover { background-color: #5a6268; }
    .btn-tertiary { background-color: #17a2b8; }
    .btn-tertiary:hover { background-color: #138496; }
    .btn-remove { background-color: #dc3545; padding: 6px 12px; font-size: 0.85em; margin: 0; width: auto; flex: none; }
    .btn-remove:hover { background-color: #c82333; }
    .error { color: #dc3545; font-size: 0.85em; margin-top: 5px; }
    .kfw-desc { font-size: 0.85em; color: #495057; background: #e9ecef; padding: 10px; border-radius: 5px; margin-top: -5px; margin-bottom: 15px; border-left: 4px solid #0056b3;}
    .pdf-hide { display: flex; }
  </style>
</head>
<body>

<div class="container" id="calculator-content">
  <h1>German Home Financing Calculator</h1>
  <p>Calculate your blended interest rate (Mischzins) and determine either the monthly payment or the years to clear the loan for your Bank, KfW, and BAFA combinations.</p>

  <div class="loan-section" id="bank-section">
    <h2>1. Standard Bank Loan</h2>
    <div class="row">
      <div class="form-group">
        <label>Loan Amount (€)</label>
        <input type="number" id="bank-amount" value="300000" min="0" step="1000" oninput="calculateAll()">
      </div>
      <div class="form-group">
        <label>Interest Rate (%)</label>
        <input type="number" id="bank-rate" value="3.8" min="0" step="0.1" oninput="calculateAll()">
      </div>
      <div class="form-group">
        <label>Calculate...</label>
        <select id="bank-calc-type" onchange="toggleInputs('bank'); calculateAll();">
          <option value="payment">Monthly Payment (from Years)</option>
          <option value="years">Years to Clear (from Payment)</option>
        </select>
      </div>
    </div>
    <div class="row">
      <div class="form-group" id="bank-input-group">
        <label id="bank-target-label">Target Duration (Years)</label>
        <input type="number" id="bank-target" value="25" min="1" step="0.5" oninput="calculateAll()">
      </div>
      <div class="result-group" id="bank-result">
        Calculated Payment: €0.00
      </div>
    </div>
    <div id="bank-error" class="error"></div>
  </div>

  <div id="kfw-container">
  </div>

  <button class="btn-secondary pdf-hide" onclick="addKfwPlan()" style="margin-bottom: 20px; width: auto; font-size: 0.9em; flex: none;">
    + Add another KfW Plan
  </button>

  <div class="loan-section" id="bafa-section">
    <h2>3. BAFA Supplementary Loan</h2>
    <div class="row">
      <div class="form-group">
        <label>Loan Amount (€)</label>
        <input type="number" id="bafa-amount" value="0" min="0" step="1000" oninput="calculateAll()">
      </div>
      <div class="form-group">
        <label>Interest Rate (%)</label>
        <input type="number" id="bafa-rate" value="2.5" min="0" step="0.1" oninput="calculateAll()">
      </div>
      <div class="form-group">
        <label>Calculate...</label>
        <select id="bafa-calc-type" onchange="toggleInputs('bafa'); calculateAll();">
          <option value="payment">Monthly Payment (from Years)</option>
          <option value="years">Years to Clear (from Payment)</option>
        </select>
      </div>
    </div>
    <div class="row">
      <div class="form-group" id="bafa-input-group">
        <label id="bafa-target-label">Target Duration (Years)</label>
        <input type="number" id="bafa-target" value="10" min="1" step="0.5" oninput="calculateAll()">
      </div>
      <div class="result-group" id="bafa-result">
        Calculated Payment: €0.00
      </div>
    </div>
    <div id="bafa-error" class="error"></div>
  </div>

  <div class="summary-section">
    <div class="summary-row">
      <div>Total Loan Amount:</div>
      <span id="total-amount">€0.00</span>
    </div>
    <div class="summary-row">
      <div>Blended Interest Rate (Mischzins):</div>
      <span id="blended-rate">0.00%</span>
    </div>
    <div class="summary-row" style="border-top: 1px solid rgba(255,255,255,0.3); padding-top: 10px; margin-top: 10px;">
      <div>Total Monthly Payment:</div>
      <span id="total-payment">€0.00</span>
    </div>
  </div>

  <div class="button-group pdf-hide" id="action-buttons">
    <button onclick="calculateAll()">Calculate</button>
    <button class="btn-secondary" onclick="exportCSV()">Export CSV</button>
    <button class="btn-tertiary" onclick="exportPDF()">Save as PDF</button>
  </div>
</div>

<script>
  let kfwCount = 0;
  let activeKfwIds = [];

  const kfwDescriptions = {
    "124": "<strong>KfW 124 (Wohneigentumsprogramm):</strong> Basic funding for buying or building an owner-occupied home. No specific energy efficiency requirements to qualify.",
    "261": "<strong>KfW 261 (Effizienzhaus):</strong> For completely renovating a property to an Efficiency House standard, or buying a newly refurbished one. Often includes repayment bonuses (Tilgungszuschuss).",
    "300": "<strong>KfW 300 (Wohneigentum für Familien):</strong> Low-interest loans for families with minor children and specific income limits buying or building a 'climate-friendly' new home.",
    "308": "<strong>KfW 308 (Jung kauft Alt):</strong> Subsidizes families with minor children buying older, highly inefficient homes (Energy Class E, F, G, or H) who commit to comprehensive energetic renovations.",
    "custom": "<strong>Custom Plan:</strong> Manually enter the parameters for any other regional, supplementary, or specific bank subsidy you might be eligible for."
  };

  function addKfwPlan() {
    const id = `kfw-${kfwCount}`;
    activeKfwIds.push(id);

    const html = `
        <div class="loan-section" id="${id}-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h2 style="margin: 0;">2. KfW Subsidized Loan</h2>
                ${kfwCount > 0 ? `<button class="btn-remove pdf-hide" onclick="removeKfwPlan('${id}')">Remove Plan</button>` : ''}
            </div>
            <div class="row">
                <div class="form-group" style="flex: 2;">
                    <label>Select KfW Plan</label>
                    <select id="${id}-plan" onchange="updateKfwPlan('${id}')">
                        <option value="124" data-max="100000" data-rate="3.63">KfW 124 (Home Ownership) - Max €100k, ~3.63%</option>
                        <option value="261" data-max="150000" data-rate="2.39">KfW 261 (Energy Efficient) - Max €150k, ~2.39%</option>
                        <option value="300" data-max="270000" data-rate="0.01">KfW 300 (Family Home) - Max €270k, ~0.01%</option>
                        <option value="308" data-max="150000" data-rate="0.01">KfW 308 "Jung kauft Alt" - Max €150k, ~0.01%</option>
                        <option value="custom" data-max="" data-rate="2.00">Custom KfW Plan - No Limit</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Interest Rate (%)</label>
                    <input type="number" id="${id}-rate" value="3.63" min="0" step="0.01" oninput="calculateAll()">
                </div>
            </div>
            <div id="${id}-desc" class="kfw-desc">${kfwDescriptions["124"]}</div>
            <div class="row">
                <div class="form-group">
                    <label>Loan Amount (€)</label>
                    <input type="number" id="${id}-amount" value="100000" min="0" max="100000" step="1000" oninput="validateKfwAmount('${id}'); calculateAll();">
                    <div id="${id}-amount-error" class="error"></div>
                </div>
                <div class="form-group">
                    <label>Calculate...</label>
                    <select id="${id}-calc-type" onchange="toggleInputs('${id}'); calculateAll();">
                        <option value="payment">Monthly Payment (from Years)</option>
                        <option value="years">Years to Clear (from Payment)</option>
                    </select>
                </div>
                <div class="form-group" id="${id}-input-group">
                    <label id="${id}-target-label">Target Duration (Years)</label>
                    <input type="number" id="${id}-target" value="20" min="1" step="0.5" oninput="calculateAll()">
                </div>
            </div>
            <div class="row">
                <div class="result-group" id="${id}-result">Calculated Payment: €0.00</div>
            </div>
            <div id="${id}-error" class="error"></div>
        </div>
        `;

    document.getElementById('kfw-container').insertAdjacentHTML('beforeend', html);
    kfwCount++;
    calculateAll();
  }

  function removeKfwPlan(id) {
    document.getElementById(`${id}-section`).remove();
    activeKfwIds = activeKfwIds.filter(kfwId => kfwId !== id);
    calculateAll();
  }

  function updateKfwPlan(id) {
    const planSelect = document.getElementById(`${id}-plan`);
    const selectedValue = planSelect.value;
    const selectedOption = planSelect.options[planSelect.selectedIndex];

    const defaultRate = selectedOption.getAttribute('data-rate');
    const maxAmount = selectedOption.getAttribute('data-max');

    if (defaultRate) document.getElementById(`${id}-rate`).value = defaultRate;
    if (maxAmount) {
      document.getElementById(`${id}-amount`).max = maxAmount;
    } else {
      document.getElementById(`${id}-amount`).removeAttribute('max');
    }

    // Update Description
    document.getElementById(`${id}-desc`).innerHTML = kfwDescriptions[selectedValue];

    validateKfwAmount(id);
    calculateAll();
  }

  function validateKfwAmount(id) {
    const amountInput = document.getElementById(`${id}-amount`);
    const errorDiv = document.getElementById(`${id}-amount-error`);
    const max = parseFloat(amountInput.max);
    const val = parseFloat(amountInput.value);

    if (max && val > max) {
      errorDiv.innerText = `Warning: Limit is €${max.toLocaleString()}.`;
    } else {
      errorDiv.innerText = '';
    }
  }

  function toggleInputs(prefix) {
    const calcType = document.getElementById(`${prefix}-calc-type`).value;
    const targetLabel = document.getElementById(`${prefix}-target-label`);

    if (calcType === 'payment') {
      targetLabel.innerText = "Target Duration (Years)";
    } else {
      targetLabel.innerText = "Target Monthly Payment (€)";
    }
  }

  function computeLoan(prefix) {
    const P = parseFloat(document.getElementById(`${prefix}-amount`).value) || 0;
    const R = parseFloat(document.getElementById(`${prefix}-rate`).value) || 0;
    const calcType = document.getElementById(`${prefix}-calc-type`).value;
    const target = parseFloat(document.getElementById(`${prefix}-target`).value) || 0;
    const resultDiv = document.getElementById(`${prefix}-result`);
    const errorDiv = document.getElementById(`${prefix}-error`);

    errorDiv.innerText = "";
    if (P === 0) {
      resultDiv.innerText = "No Loan";
      return { amount: 0, payment: 0, rate: 0, finalResult: "No Loan" };
    }

    const r = R / 100 / 12; // Monthly interest rate
    let payment = 0;
    let months = 0;
    let resultText = "";

    if (calcType === 'payment') {
      months = target * 12;
      if (months <= 0) {
        errorDiv.innerText = "Duration must be > 0.";
        return { amount: P, payment: 0, rate: R, finalResult: "Error" };
      }
      if (r === 0) {
        payment = P / months;
      } else {
        payment = P * (r * Math.pow(1 + r, months)) / (Math.pow(1 + r, months) - 1);
      }
      resultText = `Calculated Payment: €${payment.toFixed(2)}`;
      resultDiv.innerText = resultText;
      return { amount: P, payment: payment, rate: R, finalResult: resultText };
    } else {
      payment = target;
      if (payment <= P * r) {
        errorDiv.innerText = "Payment is too low to cover monthly interest. Loan will never clear.";
        resultText = `Calculated Years: Infinity`;
        resultDiv.innerText = resultText;
        return { amount: P, payment: payment, rate: R, finalResult: resultText };
      }
      if (r === 0) {
        months = P / payment;
      } else {
        months = Math.log(payment / (payment - P * r)) / Math.log(1 + r);
      }
      const years = months / 12;
      resultText = `Calculated Years: ${years.toFixed(1)} yrs`;
      resultDiv.innerText = resultText;
      return { amount: P, payment: payment, rate: R, finalResult: resultText };
    }
  }

  function calculateAll() {
    const bankData = computeLoan('bank');
    const bafaData = computeLoan('bafa');

    let totalAmount = bankData.amount + bafaData.amount;
    let totalPayment = bankData.payment + bafaData.payment;
    let weightedRateSum = (bankData.amount * bankData.rate) + (bafaData.amount * bafaData.rate);

    let allKfwData = [];

    activeKfwIds.forEach(id => {
      const kfwData = computeLoan(id);
      allKfwData.push({ id: id, data: kfwData });
      totalAmount += kfwData.amount;
      totalPayment += kfwData.payment;
      weightedRateSum += (kfwData.amount * kfwData.rate);
    });

    let blendedRate = totalAmount > 0 ? (weightedRateSum / totalAmount) : 0;

    document.getElementById('total-amount').innerText = `€${totalAmount.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
    document.getElementById('total-payment').innerText = `€${totalPayment.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
    document.getElementById('blended-rate').innerText = `${blendedRate.toFixed(2)}%`;

    return { bankData, allKfwData, bafaData, totalAmount, totalPayment, blendedRate };
  }

  function exportCSV() {
    const data = calculateAll();

    let csvContent = "data:text/csv;charset=utf-8,";
    csvContent += "Loan Type,Amount (EUR),Rate (%),Target Setting,Target Value,Result\n";

    const getRow = (prefix, name, dataObj) => {
      const typeSelect = document.getElementById(`${prefix}-calc-type`);
      const targetType = typeSelect.options[typeSelect.selectedIndex].text;
      const targetVal = document.getElementById(`${prefix}-target`).value;
      return `"${name}",${dataObj.amount},${dataObj.rate},"${targetType}",${targetVal},"${dataObj.finalResult}"`;
    };

    csvContent += getRow('bank', 'Standard Bank Loan', data.bankData) + "\n";

    data.allKfwData.forEach((kfwItem, index) => {
      const kfwSelect = document.getElementById(`${kfwItem.id}-plan`);
      const kfwName = kfwSelect.options[kfwSelect.selectedIndex].text;
      csvContent += getRow(kfwItem.id, `KfW Plan ${index + 1}: ${kfwName}`, kfwItem.data) + "\n";
    });

    csvContent += getRow('bafa', 'BAFA Supplementary', data.bafaData) + "\n";

    csvContent += `\nSUMMARY,,,,, \n`;
    csvContent += `"Total Loan Amount","€${data.totalAmount.toFixed(2)}",,,, \n`;
    csvContent += `"Blended Interest Rate","${data.blendedRate.toFixed(2)}%",,,, \n`;
    csvContent += `"Total Monthly Payment","€${data.totalPayment.toFixed(2)}",,,, \n`;

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "mortgage_calculation.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  function exportPDF() {
    const buttons = document.getElementById('action-buttons');
    const kfwButtons = document.querySelectorAll('.pdf-hide');

    kfwButtons.forEach(btn => btn.style.display = 'none');
    buttons.style.display = 'none';

    const element = document.getElementById('calculator-content');
    const opt = {
      margin:       15,
      filename:     'mortgage_calculation.pdf',
      image:        { type: 'jpeg', quality: 0.98 },
      html2canvas:  { scale: 2 },
      jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };

    html2pdf().set(opt).from(element).save().then(() => {
      buttons.style.display = 'flex';
      kfwButtons.forEach(btn => btn.style.display = '');
    });
  }

  window.onload = function() {
    addKfwPlan();
  };
</script>

</body>
</html>
